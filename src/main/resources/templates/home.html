<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<div th:insert="/head::head"> </div>

<body>
  <div class="invitation hidden">
    <p>You have an invitation from <span id="invi__name"></span></p>
    <button type="button" class="btn btn-success">Accept</button>
    <button type="button" class="btn btn-danger">Decline</button>
  </div>


  <div class="main">
    <div class="row">
      <div class="col-12 d-flex justify-content-between">
        <h1>TicTacToe Online</h1>
        <div>
          <span>Hello <span th:text="${session.account.name}" id="name">Ã¡dasd</span></span> <br>
          <span>Your point: <span th:text="${session.account.point}"></span></span> <br>
          <a href="/logout" id="disconnect">Log out</a>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-5">
        <div class="row">
          <div class="col-md-12">
              <table id="conversation" class="table table-striped">
                  <thead>
                  <tr>
                      <th colspan="3">Online</th>
                  </tr>
                  </thead>
                  <tbody id="greetings">
                  </tbody>
                  
              </table>
          </div>
      </div>
      </div>
      <div class="col-7">

      </div>
    </div>
  </div>

</body>
<script th:inline="javascript">
  var stompClient = null;

  function connect() {
    var socket = new SockJS('/ttt-websocket');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, function (frame) {
      console.log('Connected: ' + frame);
      stompClient.subscribe('/login/new', function (greeting) {
        resetAccountList(greeting);
      });
      let id = /*[[${session.account.id}]]*/;
      stompClient.subscribe('/login/' + id, function (msgOut) {
          showInvite(msgOut);
      });
      newLogin();
    });
  }

  function disconnect() {
    if (stompClient !== null) {
      stompClient.disconnect();
    }
    setConnected(false);
    console.log("Disconnected");
  }

  function newLogin() {
    let id = /*[[${session.account.id}]]*/;
    stompClient.send("/app/hello", {}, id);
  }

  function resetAccountList(greeting) {
    let accList = JSON.parse(greeting.body);
    document.getElementById("greetings").innerHTML = ' ';
    let id = /*[[${session.account.id}]]*/;
    let name = /*[[${session.account.name}]]*/;
    for(i in accList){
      $("#greetings").append(`<tr><td>${accList[i].id}</td><td>${accList[i].name}</td><td><button onclick="challenge(${id}, ${accList[i].id}, '${name}')">Challenge</button></td></tr>`);
    }
  }
  $(document).ready(function () {
    $("form").on('submit', function (e) {
      e.preventDefault();
    });
    connect();
    $("#disconnect").click(function () { newLogin(); });
  });
  function challenge(id1, id2, name){
    stompClient.send("/app/invite", {}, id1 + " " + id2 + " " + name);
  }
  function showInvite(msg){
    let temp = msg.body.split(" ");
    $('.invitation').removeClass('hidden');
    document.getElementById("invi__name").innerHTML = temp[1];
  }
</script>

</html>