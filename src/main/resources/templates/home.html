<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<div th:insert="/head::head"> </div>

<body>
  <div class="main">
    <div class="row">
      <div class="col-12 d-flex justify-content-between">
        <h1>TicTacToe Online</h1>
        <div>
          <span>Hello <span th:text="${session.account.name}" id="name">Ã¡dasd</span></span> <br>
          <span>Your point: <span th:text="${session.account.point}"></span></span> <br>
          <a href="/logout" id="disconnect">Log out</a>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-5">
        <div class="row">
          <div class="col-md-12">
              <table id="conversation" class="table table-striped">
                  <thead>
                  <tr>
                      <th colspan="2">Online</th>
                  </tr>
                  </thead>
                  <tbody id="greetings">
                    <tr th:each="acc: ${session.online}">
                        <td th:text="${acc.id}" />
                        <td th:text="${acc.name}" />
                    </tr>
                  </tbody>
                  
              </table>
          </div>
      </div>
      </div>
      <div class="col-7">

      </div>
    </div>
  </div>

</body>
<script th:inline="javascript">
  var stompClient = null;

  function connect() {
    var socket = new SockJS('/ttt-websocket');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, function (frame) {
      console.log('Connected: ' + frame);
      stompClient.subscribe('/login/new', function (greeting) {
        resetAccountList(greeting);
      });
      newLogin();
    });
  }

  function disconnect() {
    if (stompClient !== null) {
      stompClient.disconnect();
    }
    setConnected(false);
    console.log("Disconnected");
  }

  function newLogin() {
    let id = /*[[${session.account.id}]]*/;
    stompClient.send("/app/hello", {}, id);
  }

  function resetAccountList(greeting) {
    let accList = JSON.parse(greeting.body);
    document.getElementById("greetings").innerHTML = ' ';
    for(i in accList){
      $("#greetings").append(`<tr><td>${accList[i].id}</td><td>${accList[i].name}</td></tr>`);
    }
  }
  $(document).ready(function () {
    $("form").on('submit', function (e) {
      e.preventDefault();
    });
    connect();
    $("#disconnect").click(function () { newLogin(); });
  });
</script>

</html>